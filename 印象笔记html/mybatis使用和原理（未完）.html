<html>
<head>
  <title>mybatis使用和原理（未完）</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600480 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="519"/>
<h1>mybatis使用和原理（未完）</h1>

<div>
<span><div>案例中spring配置只用于实例化service层，故略去</div><div><br/></div><div><br/></div><div>1.mybatis-config.xml的配置</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-size: 9pt; color: rgb(0, 0, 0); font-family: Monaco;">&lt;?</span><span style="font-size: 9pt; color: rgb(0, 0, 0); font-family: Monaco;">xml version</span><span style="font-size: 9pt; color: rgb(0, 0, 0); font-family: Monaco;">=&quot;1.0&quot;</span> <span style="font-size: 9pt; color: rgb(0, 0, 0); font-family: Monaco;">encoding</span><span style="font-size: 9pt; color: rgb(0, 0, 0); font-family: Monaco;">=&quot;UTF-8&quot;</span> <span style="font-size: 9pt; color: rgb(0, 0, 0); font-family: Monaco;">?&gt;</span></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">&lt;!DOCTYPE</span> <span style="font-family: Monaco; font-size: 9pt;">configuration</span> <span style="font-family: Monaco; font-size: 9pt;">PUBLIC</span> <span style="font-family: Monaco; font-size: 9pt;">&quot;-//<a href="http://ibatis.apache.org//DTD" style="color: rgb(0, 0, 0);">ibatis.apache.org//DTD</a> Config 3.0//EN&quot; &quot;<a href="http://ibatis.apache.org/dtd/ibatis-3-config.dtd" style="color: rgb(0, 0, 0);">http://ibatis.apache.org/dtd/ibatis-3-config.dtd</a>&quot;</span><span style="font-family: Monaco; font-size: 9pt;">&gt;</span></font></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#000000">&lt;configuration&gt;</font></span></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#000000">&lt;settings&gt;</font></span></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">&lt;setting</span> <span style="font-family: Monaco; font-size: 9pt;">name</span><span style="font-family: Monaco; font-size: 9pt;">=&quot;mapUnderscoreToCamelCase&quot;</span> <span style="font-family: Monaco; font-size: 9pt;">value</span><span style="font-family: Monaco; font-size: 9pt;">=&quot;true&quot;</span><span style="font-family: Monaco; font-size: 9pt;">/&gt;</span></font></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#000000">&lt;/settings&gt;</font></span></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">&lt;environments</span> <span style="font-family: Monaco; font-size: 9pt;">default</span><span style="font-family: Monaco; font-size: 9pt;">=&quot;environment&quot;</span><span style="font-family: Monaco; font-size: 9pt;">&gt;</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">&lt;environment</span> <span style="font-family: Monaco; font-size: 9pt;">id</span><span style="font-family: Monaco; font-size: 9pt;">=&quot;environment&quot;</span><span style="font-family: Monaco; font-size: 9pt;">&gt;</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">&lt;transactionManager</span> <span style="font-family: Monaco; font-size: 9pt;">type</span><span style="font-family: Monaco; font-size: 9pt;">=&quot;JDBC&quot;</span> <span style="font-family: Monaco; font-size: 9pt;">/&gt;</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">&lt;dataSource</span> <span style="font-family: Monaco; font-size: 9pt;">type</span><span style="font-family: Monaco; font-size: 9pt;">=&quot;POOLED&quot;</span><span style="font-family: Monaco; font-size: 9pt;">&gt;</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">&lt;property</span> <span style="font-family: Monaco; font-size: 9pt;">name</span><span style="font-family: Monaco; font-size: 9pt;">=&quot;driver&quot;</span> <span style="font-family: Monaco; font-size: 9pt;">value</span><span style="font-family: Monaco; font-size: 9pt;">=&quot;com.mysql.jdbc.Driver&quot;</span> <span style="font-family: Monaco; font-size: 9pt;">/&gt;</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">&lt;property</span> <span style="font-family: Monaco; font-size: 9pt;">name</span><span style="font-family: Monaco; font-size: 9pt;">=&quot;url&quot;</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">value</span><span style="font-family: Monaco; font-size: 9pt;">=&quot;jdbc:<a href="mysql://localhost:3306/practice?serverTimezone=UTC" style="color: rgb(0, 0, 0);">mysql://localhost:3306/practice?serverTimezone=UTC</a>&quot;</span> <span style="font-family: Monaco; font-size: 9pt;">/&gt;</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">&lt;property</span> <span style="font-family: Monaco; font-size: 9pt;">name</span><span style="font-family: Monaco; font-size: 9pt;">=&quot;username&quot;</span> <span style="font-family: Monaco; font-size: 9pt;">value</span><span style="font-family: Monaco; font-size: 9pt;">=&quot;root&quot;</span> <span style="font-family: Monaco; font-size: 9pt;">/&gt;</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">&lt;property</span> <span style="font-family: Monaco; font-size: 9pt;">name</span><span style="font-family: Monaco; font-size: 9pt;">=&quot;password&quot;</span> <span style="font-family: Monaco; font-size: 9pt;">value</span><span style="font-family: Monaco; font-size: 9pt;">=&quot;123456&quot;</span> <span style="font-family: Monaco; font-size: 9pt;">/&gt;</span></font></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#000000">&lt;/dataSource&gt;</font></span></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#000000">&lt;/environment&gt;</font></span></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#000000">&lt;/environments&gt;</font></span></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#000000">&lt;mappers&gt;</font></span></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">&lt;mapper</span> <span style="font-family: Monaco; font-size: 9pt;">resource</span><span style="font-family: Monaco; font-size: 9pt;">=&quot;dao/mapper/UserMapper.xml&quot;</span><span style="font-family: Monaco; font-size: 9pt;">/&gt;</span></font></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#000000">&lt;/mappers&gt;</font></span></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#000000">&lt;/configuration&gt;</font></span></div></div><div><br/></div><div>2.ServiceImpl层</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><br style="font-family: Monaco; font-size: 9pt;"/></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#000000">@Service</font></span></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">public class</span> <span style="font-family: Monaco; font-size: 9pt;">ServiceImpl</span> <span style="font-family: Monaco; font-size: 9pt;">implements</span> <span style="font-family: Monaco; font-size: 9pt;">IService {</span></font></div><div><br style="font-family: Monaco; font-size: 9pt;"/></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">@Override</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">public</span> <span style="font-family: Monaco; font-size: 9pt;">List&lt;UserBean&gt;</span> <span style="font-family: Monaco; font-size: 9pt;">query</span><span style="font-family: Monaco; font-size: 9pt;">()</span> <span style="font-family: Monaco; font-size: 9pt;">throws</span> <span style="font-family: Monaco; font-size: 9pt;">IOException {</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">String resource =</span> <span style="font-family: Monaco; font-size: 9pt;">&quot;config/mybatis-config.xml&quot;</span><span style="font-family: Monaco; font-size: 9pt;">;</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">InputStream inputStream = Resources.</span><span style="font-style: italic; font-family: Monaco; font-size: 9pt;">getResourceAsStream</span><span style="font-family: Monaco; font-size: 9pt;">(resource)</span><span style="font-family: Monaco; font-size: 9pt;">;</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">SqlSessionFactory sqlSessionFactory =</span> <span style="font-family: Monaco; font-size: 9pt;">new</span> <span style="font-family: Monaco; font-size: 9pt;">SqlSessionFactoryBuilder().build(inputStream)</span><span style="font-family: Monaco; font-size: 9pt;">;</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">SqlSession session = sqlSessionFactory.openSession()</span><span style="font-family: Monaco; font-size: 9pt;">;</span></font></div><div><font style="color: rgb(0, 0, 0);"><span style="font-family: Monaco; font-size: 9pt;">UserMapper userMapper = session.getMapper(UserMapper.</span><span style="font-family: Monaco; font-size: 9pt;">class</span><span style="font-family: Monaco; font-size: 9pt;">)</span><span style="font-family: Monaco; font-size: 9pt;">;</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">List&lt;UserBean&gt; userBean = userMapper.selectUserList()</span><span style="font-family: Monaco; font-size: 9pt;">;</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">for</span><span style="font-family: Monaco; font-size: 9pt;">(UserBean u:userBean) {</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">System.</span><span style="font-style: italic; font-family: Monaco; font-size: 9pt;">out</span><span style="font-family: Monaco; font-size: 9pt;">.println(u.toString())</span><span style="font-family: Monaco; font-size: 9pt;">;</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">}</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">return</span> <span style="font-family: Monaco; font-size: 9pt;">userBean</span><span style="font-family: Monaco; font-size: 9pt;">;</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">}</span></font></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#000000">}</font></span></div></div><div><br/></div><div>3.mapper层（对应的xml不写了）</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">public interface</span> <span style="font-family: Monaco; font-size: 9pt;">UserMapper {</span></font></div><div><br/></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">List&lt;UserBean&gt;</span> <span style="font-family: Monaco; font-size: 9pt;">selectUserList</span><span style="font-family: Monaco; font-size: 9pt;">()</span><span style="font-family: Monaco; font-size: 9pt;">;</span></font></div><div><br style="font-family: Monaco; font-size: 9pt;"/></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">@Select</span><span style="font-family: Monaco; font-size: 9pt;">(</span><span style="font-family: Monaco; font-size: 9pt;">&quot;SELECT * FROM User WHERE id = #{id}&quot;</span><span style="font-family: Monaco; font-size: 9pt;">)</span></font></div><div><font color="#000000"><span style="font-family: Monaco; font-size: 9pt;">UserBean</span> <span style="font-family: Monaco; font-size: 9pt;">autoSelectUserList</span><span style="font-family: Monaco; font-size: 9pt;">(</span><span style="font-family: Monaco; font-size: 9pt;">int</span> <span style="font-family: Monaco; font-size: 9pt;">id)</span><span style="font-family: Monaco; font-size: 9pt;">;</span></font></div><div><span style="font-family: Monaco; font-size: 9pt;"><font color="#000000">}</font></span></div></div><div><br/></div><div><br/></div><div><br/></div><div>4.核心代码分析</div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="color: #000000; font-family: Monaco; font-size: 9pt;">UserMapper userMapper = session.getMapper(UserMapper.</span><span style="color: #000000; font-family: Monaco; font-size: 9pt;">class</span><span style="color: #000000; font-family: Monaco; font-size: 9pt;">)</span><span style="color: #000000; font-family: Monaco; font-size: 9pt;">;</span></div></div><div><br/></div><div>检查源码，发现getMapper返回的是泛型，也就是在UserMapper传入的时候，除了实现UserMapper接口中的方法，在方法中具体填充了“注册驱动，获取连接，执行sql”，然后返回到UserMapper接口。</div><div>实现父类引用指向子类对象。</div><div><br/></div><div>5.MapperFactoryBean来动态代理，“去除了”  SqlSession获取mapper这一步。没有泛型，具体是怎么在xml配置的情况下实现的呢。</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 