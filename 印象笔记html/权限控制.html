<html>
<head>
  <title>权限控制</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600480 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="671"/>
<h1>权限控制</h1>

<div>
<span><div>整合了Shiro之后的接口，直接在接口上加注解就可以针对用户角色或者针对不同用户来设置条件</div><div><br/></div><div>@RequiresRoles(&quot;user&quot;) 针对角色粒度，如果角色有user权限，则可以访问</div><div>@RequiresPermissions({&quot;QUERY_CASH&quot;}) 针对用户粒度，如果用户有QUERY_CASH权限，则可以访问</div><div><br/></div><div>当然这些权限CODE判断都是在扫描到</div><div>@RequiresRoles </div><div>@RequiresPermissions</div><div>这些注解的时候，才会自动调用<span style="color: rgb(51, 51, 51); font-size: 10pt;">doGetAuthorizationInfo方法</span></div><div><br/></div><div><span style="color: rgb(51, 51, 51); font-size: 10pt;">登录时，shiro会将token传递给自定义realm,此时realm会先调用</span><span style="font-size: 10pt; color: rgb(51, 51, 51);">doGetAuthenticationInfo(AuthenticationToken authcToken )登录验证的方法，验证通过后会接着调用 doGetAuthorizationInfo(PrincipalCollection principals)获取角色和权限的方法（授权），最后返回结果。</span></div><div><span style="font-size: 10pt; color: rgb(51, 51, 51);">   </span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">import org.apache.shiro.authz.SimpleAuthorizationInfo;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">import org.apache.shiro.realm.AuthorizingRealm;</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">public class JwtAuthRealm extends AuthorizingRealm {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">/**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * 授权(验证权限时调用)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     *</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * @param principals 身份</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * @return 授权信息</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@Override</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">protected AuthorizationInfo doGetAuthorizationInfo(PrincipalCollection principals) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        UserProvider userProvider = (UserProvider) principals.getPrimaryPrincipal();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        //此处获取Permission</span></div><div><span style="font-family: Monaco; font-size: 9pt;">    </span><span style="font-family: Monaco; font-size: 9pt;">    </span><span style="font-family: Monaco; font-size: 9pt;">AuthProvider user = subjectAccess.permission(userProvider.getId(), userProvider.getTokenMode());</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        SimpleAuthorizationInfo simpleAuthorizationInfo = new SimpleAuthorizationInfo();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        simpleAuthorizationInfo.addRoles(user.getRoles());</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">...</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div><div><br/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">/**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * 认证(登录时调用)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    @Override</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    protected AuthenticationInfo doGetAuthenticationInfo(AuthenticationToken auth) throws AuthenticationException {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        ISubjectAccess subjectAccess = SpringContextHolder.getBean(ISubjectAccess.class);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        TokenProvider tokenProvider = SpringContextHolder.getBean(TokenProvider.class);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        JwtToken jwtToken = (JwtToken) auth;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        String token = jwtToken.getToken();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        // 解密获得username，用于和数据库进行对比</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        final Claims claims = tokenProvider.resolveClaims(token);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        String username = claims.getSubject();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        if (StringUtils.isEmpty(username)) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            throw new CredentialsException(&quot;授权TOKEN无法解析！&quot;);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        final AuthMode mode = tokenProvider.tokenAuthMode(claims);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        final Optional&lt;UserProvider&gt; userinfoOpt = subjectAccess.userinfo(username, mode);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        if (!userinfoOpt.isPresent()) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            throw new UnknownAccountException();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        final UserProvider userProvider = userinfoOpt.get();</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        if (!StringUtils.equals(userProvider.getStatus(), ENABLE_STATUS)) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            throw new DisabledAccountException();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return new SimpleAuthenticationInfo(userProvider, token, &quot;i2hy_trading_token&quot;);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div><div><br/></div></span>
</div></body></html> 