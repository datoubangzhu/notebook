<html>
<head>
  <title>springmvc 3全局异常处理</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600480 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="819"/>
<h1>springmvc 3全局异常处理</h1>

<div>
<span><div><div>springmvc提供了异常处理机制：</div><div>@ExceptionHandler 与 <span style="font-size: 9pt; font-family: Monaco;">@ControllerAdvice。@ControllerAdvice标注的类中的具体异常处理也是用@Exception</span><span style="font-family: Monaco; font-size: 9pt;">Handler。</span></div><div><span style="font-size: 9pt; font-family: Monaco;">@Exception</span><span style="font-family: Monaco; font-size: 9pt;">Handler单独在</span><span style="font-family: Monaco; font-size: 9pt;">方法注解, 作用于 Controller 级别. ExceptionHandler 注解为一个 Controler 定义一个异常处理器.</span></div><div><span style="font-size: 9pt; font-family: Monaco;">ControllerAdvice, 类注解, 作用于 整个 Spring 工程. ControllerAdvice 注解定义了一个全局的异常处理器.</span></div><div><span style="font-size: 9pt; font-family: Monaco;">ExceptionHandler 的优先级比 ControllerAdvice 高。</span></div><ul><li><div><span style="font-size: 9pt; font-family: Monaco;">对异常进行单独特殊处理</span></div></li></ul><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>@RestController</div><div>public class DemoController {</div><div>@ExceptionHandler(NullPointerException.class)</div><div>    public String controllerExceptionHandler(HttpServletRequest req, Exception e) {</div><div>        logger.error(&quot;---ControllerException Handler---Host {} invokes url {} ERROR: {}&quot;, req.getRemoteHost(), req.getRequestURL(), e.getMessage());</div><div>        return e.getMessage();</div><div>    }</div><div>}</div></div><div><br/></div><div><br/></div><div><br/></div><ul><li><div>拦截异常做全局处理</div></li></ul><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">import org.springframework.http.HttpStatus;</span></div><div><br/></div><div><br/></div><div><span style="font-family: Monaco; font-size: 9pt;">@ControllerAdvice</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">public class GlobalExceptionHandler {</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    private static final Logger logger = LoggerFactory.getLogger(GlobalExceptionHandler.class);</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    @ResponseStatus(HttpStatus.BAD_REQUEST)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    @ExceptionHandler(value = BussinessException.class)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    @ResponseBody</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public RspBodyModel bussinessException(BussinessException e) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        logger.error(&quot;bussiness has exception!&quot;, e);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        final String message = e.getMessage();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return RspBodyModel.builder().code(e.getErrorCode())</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                .message(message).build();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    @ExceptionHandler(value = Exception.class)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    @ResponseBody</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public RspBodyModel exception(Exception e) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        logger.error(&quot;bussiness has exception!&quot;, e);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        final String message = e.getMessage();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return RspBodyModel.builder().code(BasicCode.SYS_ERROR)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                .message(message).build();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">/**</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">* <span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">@Valid  </span>参数校验异常 </span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">*/</span></div><div><br/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    @ResponseStatus(HttpStatus.INTERNAL_SERVER_ERROR)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    @ExceptionHandler(value = MethodArgumentNotValidException.class)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    @ResponseBody</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public RspBodyModel exception(MethodArgumentNotValidException e) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        logger.error(&quot;参数校验错误!&quot;, e);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        final BindingResult bindingResult = e.getBindingResult();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        final List&lt;ObjectError&gt; errorList = bindingResult.getAllErrors();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        String message = &quot;参数传递错误&quot;;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        if (CollectionUtils.isNotEmpty(errorList)) {</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            List&lt;String&gt; errorMessages = Lists.newArrayListWithCapacity(errorList.size());</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            for (ObjectError objectError : errorList) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                errorMessages.add(objectError.getDefaultMessage());</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            message = JSON.toJSONString(errorMessages);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return RspBodyModel.builder()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                .code(BasicCode.PARAM_VALID)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                .message(message)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                .build();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">/**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">*异常展示类</span></div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">*/</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">@Data</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">public class RspBodyModel implements Serializable {</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    private static final long serialVersionUID = -164694631311L;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    /**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * 错误代码</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    private final int code;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    /**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * 消息提醒</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    private final String message;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    /**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     * 所有错误</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">     */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    private final List&lt;ErrorObject&gt; allErrors;</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    private RspBodyModel(int code, String message, List&lt;ErrorObject&gt; allErrors) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        this.code = code;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        this.message = message;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        this.allErrors = allErrors;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public static RspBodyModelBuilder builder() {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return new RspBodyModelBuilder();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    public static class RspBodyModelBuilder {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        /**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">         * 错误代码</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">         */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        private ErrorCode code;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        /**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">         * 消息提醒</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">         */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        private String message;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        /**</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">         * 所有错误</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">         */</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        private List&lt;ErrorObject&gt; allErrors;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        private RspBodyModelBuilder() {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        public RspBodyModelBuilder code(ErrorCode errorCode) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            this.code = errorCode;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            return this;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        public RspBodyModelBuilder message(String message) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            this.message = message;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            return this;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        public RspBodyModelBuilder allErrors(List&lt;ErrorObject&gt; allErrors) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            this.allErrors = allErrors;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            return this;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        public RspBodyModel build() {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            return new RspBodyModel(code.getCode(), message, allErrors);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">}</span></div></div><div><br/></div></div><div><br/></div></span>
</div></body></html> 