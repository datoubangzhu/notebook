<html>
<head>
  <title>草稿纸</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/600480 (zh-CN, DDL); Windows/6.1.1 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="455"/>
<h1>草稿纸</h1>

<div>
<span><div>这样做不行</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">private synchronized FuturesOrders optimisticLock(FuturesOrderDto directive,FuturesOrders futuresOrders){</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        String directiveSn = directive.getDirective();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        final int directiveVolume = MoreObjects.firstNonNull(directive.getVolume(), 0);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        //开启新事物</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        DefaultTransactionDefinition transDefinition = new DefaultTransactionDefinition();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        transDefinition.setPropagationBehavior(DefaultTransactionDefinition.PROPAGATION_REQUIRED);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        TransactionStatus transStatus = dataSourceTransactionManager.getTransaction(transDefinition);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        try {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            //1.防止同一时刻并发，增加乐观锁；防止rabbitMQ发送过程宕机，增加指令单lockedNum</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            //1.1累计手数</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            final Optional&lt;FuturesOrders&gt; directiveOrderOpt = this.findBySnAndType(directiveSn, OrderTypeEnum.PRE_ORDER);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            if(!directiveOrderOpt.isPresent()){</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                throw new BussinessException(&quot;指令单不存在&quot;, BasicCode.DB_ERROR);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            FuturesOrders directiveOrder = directiveOrderOpt.get();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            Long updateTime = directiveOrder.getUpdateTime();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            int dbVolume = MoreObjects.firstNonNull(directiveOrder.getVolumeLocked(), 0);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            int lockedVolume = dbVolume + directiveVolume;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            FuturesOrders updateOrders = new FuturesOrders();</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            updateOrders.setUpdateTime(TimeUtil.timeMills());</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            updateOrders.setVolumeLocked(lockedVolume);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            //1.2验证时间戳并更新，更新锁定手数</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            boolean sync =  this.update(updateOrders, new EntityWrapper&lt;FuturesOrders&gt;()</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    .eq(&quot;SN&quot;,directiveSn)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    .eq(&quot;UPDATE_TIME&quot;,updateTime)</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                    .eq(&quot;DELETE_FLAG&quot;, StringPool.ZERO));</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            if(!sync){</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                LOGGER.error(&quot;并发异常:{}&quot;, directive);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                dataSourceTransactionManager.rollback(transStatus);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                throw new BussinessException(&quot;并发异常&quot;,BasicCode.DB_ERROR);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            //1.3执行委托单插入</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            boolean result = this.insert(futuresOrders);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            if (!result) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                LOGGER.error(&quot;下单数据创建失败:{}&quot;, directive);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                dataSourceTransactionManager.rollback(transStatus);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">                throw new BussinessException(BasicCode.DB_ERROR);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            }</span></div><div><a href="http://datasourcetransactionmanager.commit(transstatus);/" style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">dataSourceTransactionManager.commit(transStatus);</a></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        } catch (Exception e) {</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">            dataSourceTransactionManager.rollback(transStatus);</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        }</span></div><div><br style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);"/></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">        return futuresOrders;</span></div><div><span style="font-family: Monaco; font-size: 9pt; color: rgb(51, 51, 51);">    }</span></div></div><div><br/></div><div><br/></div><div><br/></div><div>1.jdbc连接获取数据步骤</div><div>2.前端</div><div>3.&lt;%%&gt;和&lt;%!%&gt;的区别</div><div>4.怎么输出指定字符编码的字符串</div><div>5.MySQL oracle sqlserver分页不同sql</div><div>6.冯硕翻墙</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 